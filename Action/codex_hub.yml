name: "Codex Intelligence Hub"

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  codex_brain:
    # ä»…åœ¨ PR/Issue è¯„è®ºåŒ…å« @codexï¼Œæˆ– PR è‡ªåŠ¨è§¦å‘æ—¶è¿è¡Œ
    if: |
      github.actor != 'renovate[bot]' &&
      github.actor != 'dependabot[bot]' &&
      (github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@codex')))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch and Mask Intelligence (Gist)
        id: gist_config
        run: |
          set -euo pipefail

          # 1. è·å–é…ç½®
          CONFIG=$(curl -s -f -L "${{ secrets.GIST_CONFIG_URL }}")

          KEY=$(echo "$CONFIG" | jq -r '.api_key')
          URL=$(echo "$CONFIG" | jq -r '.base_url')
          AGENTS_URL=$(echo "$CONFIG" | jq -r '.agents_gist_url')
          PROMPTS_URL=$(echo "$CONFIG" | jq -r '.prompts_gist_url')

          # æ ¡éªŒå…³é”®å˜é‡
          if [ -z "$KEY" ] || [ "$KEY" = "null" ]; then
            echo "::error::api_key æœªé…ç½®æˆ–ä¸ºç©º"
            exit 1
          fi
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "::error::base_url æœªé…ç½®æˆ–ä¸ºç©º"
            exit 1
          fi

          # 2. æ ¸å¿ƒï¼šå…¨é‡æ©ç  (é˜²æ­¢åœ¨æ—¥å¿—ä¸­æ˜¾ç¤º)
          echo "::add-mask::$KEY"
          echo "::add-mask::$URL"

          # 3. è¾“å‡ºç»™åç»­æ­¥éª¤
          echo "key=$KEY" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "model=$(echo "$CONFIG" | jq -r '.model // "gpt-5.2"')" >> $GITHUB_OUTPUT

          # 4. ä¸‹è½½é€»è¾‘èµ„äº§
          mkdir -p .github/assets
          curl -s -f -L "$AGENTS_URL" -o .github/assets/AGENTS.md || echo "No Agents"
          curl -s -f -L "$PROMPTS_URL" -o .github/assets/SYSTEM_PROMPTS.md || echo "No Prompts"

      - name: Prepare Context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USER_CMD: ${{ github.event.comment.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          EVENT_NAME: ${{ github.event_name }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          IS_PR_COMMENT: ${{ github.event.issue.pull_request }}
        run: |
          set -euo pipefail

          # 1. é¢„è®¾è¿‡æ»¤è§„åˆ™
          FILTER=":!*.lock :!*-lock.json :!*.md :!*.svg :!*.png"

          if [ "$EVENT_NAME" == "pull_request" ]; then
            # åœºæ™¯ A: PR è‡ªåŠ¨å®¡æŸ¥ (è¯»å– Diff)
            DIFF=$(git diff "${BASE_SHA}..${HEAD_SHA}" -- . $FILTER | tail -c 8000)
            DATA="PR è‡ªåŠ¨å®¡è®¡æ¨¡å¼ã€‚ä»£ç å˜æ›´å¦‚ä¸‹ï¼š\n$DIFF"
            TASK="è¯·è¿›è¡Œä»£ç è´¨é‡ä¸å®‰å…¨å®¡æŸ¥ã€‚"

          elif [ "$IS_PR_COMMENT" != "null" ] && [ -n "$IS_PR_COMMENT" ]; then
            # åœºæ™¯ B: PR è¯„è®ºå¬å”¤ (è¯»å– Diff + ç”¨æˆ·æŒ‡ä»¤)
            DIFF=$(gh pr diff "$ISSUE_NUM" -- . $FILTER | tail -c 8000)
            DATA="PR ä»£ç ä¸Šä¸‹æ–‡ï¼š\n$DIFF"
            TASK="ç”¨æˆ·æŒ‡ä»¤ï¼š$USER_CMD"

          else
            # åœºæ™¯ C: çº¯ Issue å¬å”¤ (è¯»å– Issue æ ‡é¢˜/æ­£æ–‡ + ç”¨æˆ·æŒ‡ä»¤ + ç›®å½•æ ‘)
            TREE=$(find . -maxdepth 2 -not -path '*/.*' | sed 's/$/\\n/' | tr -d '\n')
            DATA="Issue èƒŒæ™¯ä¿¡æ¯ï¼š\næ ‡é¢˜ï¼š$ISSUE_TITLE\nå†…å®¹ï¼š$ISSUE_BODY\n\né¡¹ç›®ç»“æ„ï¼š\n$TREE"
            TASK="å½“å‰ç”¨æˆ·æŒ‡ä»¤ï¼š$USER_CMD"
          fi

          # 2. æ³¨å…¥ System Prompt (ä» Gist ä¸‹è½½çš„èµ„äº§)
          SYSTEM_P="ä½ æ˜¯ä¸€ä¸ªå…¨èƒ½åŠ©æ‰‹ï¼Œè¯·ä¸¥æ ¼ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ã€‚"
          if [ -f ".github/assets/SYSTEM_PROMPTS.md" ]; then
             SYSTEM_P=$(cat .github/assets/SYSTEM_PROMPTS.md)
          fi

          # 3. ç»„åˆæˆæœ€ç»ˆ Prompt
          echo "final_prompt<<EOF" >> $GITHUB_OUTPUT
          echo "--- ç³»ç»ŸæŒ‡ä»¤ ---" >> $GITHUB_OUTPUT
          echo "$SYSTEM_P" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "--- ä¸Šä¸‹æ–‡æ•°æ® ---" >> $GITHUB_OUTPUT
          echo -e "$DATA" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "--- æ‰§è¡Œä»»åŠ¡ ---" >> $GITHUB_OUTPUT
          echo -e "$TASK" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run OpenAI Codex Action
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ steps.gist_config.outputs.key }}
          model: ${{ steps.gist_config.outputs.model }}
          responses-api-endpoint: "${{ steps.gist_config.outputs.url }}/v1/responses"
          agents-config: ".github/assets/AGENTS.md"
          prompt: ${{ steps.context.outputs.final_prompt }}

      - name: Post Results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RESPONSE: ${{ steps.codex.outputs.final-message }}
          NUM: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          set -euo pipefail
          if [ -n "$RESPONSE" ]; then
            gh issue comment "$NUM" --body "### ğŸ¤– Codex Intelligence Result
          $RESPONSE"
          fi
